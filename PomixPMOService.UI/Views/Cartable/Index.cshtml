@model IEnumerable<PomixPMOService.UI.ViewModels.CartableItemViewModel>
@{
    ViewData["Title"] = "کارتابل";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="input-group mb-5">
    <input type="text" class="form-control" placeholder="جستجو">
    <div class="input-group-text btn btn-primary">
        <i class="fa fa-search" aria-hidden="true"></i>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <h2 class="card-title">درخواست‌ها</h2>
        <button id="AddDoc" type="button" class="btn btn-primary btn-pill left-btn" data-bs-toggle="modal" data-bs-target="#scrollingmodal">سند جدید</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <div id="basic-datatable_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <table id="cartableTable" class="table table-bordered text-nowrap border-bottom">
                            <thead>
                                <tr role="row">
                                    <th class="wd-15p border-bottom-0 sorting sorting_asc">شماره درخواست</th>
                                    <th class="wd-15p border-bottom-0 sorting">کد ملی</th>
                                    <th class="wd-20p border-bottom-0 sorting">شماره همراه</th>
                                    <th class="wd-15p border-bottom-0 sorting">شناسه سند</th>
                                    <th class="wd-10p border-bottom-0 sorting">رمز تصدیق</th>
                                    <th class="wd-10p border-bottom-0 sorting">وضعیت احراز هویت</th>
                                    <th class="wd-10p border-bottom-0 sorting">وجود سند</th>
                                    <th class="wd-15p border-bottom-0 sorting">بررسی سند</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>@item.RequestId</td>
                                            <td>@item.NationalId</td>
                                            <td>@item.MobileNumber</td>
                                            <td>@item.DocumentNumber</td>
                                            <td>@item.VerificationCode</td>
                                            <td>
                                                <i class="fas fa-check-circle text-success" title="تأیید شده" style="@(item.IdentityVerified ? "" : "display: none;")"></i>
                                            </td>
                                            <td>
                                                <i class="fas fa-file-alt text-success" title="سند موجود" style="@(item.DocumentExists ? "" : "display: none;")"></i>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary verify-btn" data-document-id="@item.DocumentNumber" data-status="@item.Status" onclick="verifyDocument(this)">
                                                    بررسی
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center">درخواستی یافت نشد.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="scrollingmodal" tabindex="-1" aria-labelledby="scrollingmodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-demo">
            <div class="modal-header">
                <h6 class="modal-title" id="scrollingmodalLabel">سند جدید</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <form class="needs-validation" novalidate="">
                            <div class="form-row">
                                <div class="col-xl-6 mb-3">
                                    <label for="validationCustom01">کد ملی</label>
                                    <input type="text" class="form-control" id="validationCustom01" value="" required="">
                                </div>
                                <div class="col-xl-6 mb-3">
                                    <label for="validationCustom02">شماره موبایل</label>
                                    <input type="text" class="form-control" id="validationCustom02" value="09xxxxxxxxx" required="">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-xl-6 mb-3">
                                    <label for="validationCustom03">رمز تصدیق</label>
                                    <input type="text" class="form-control" id="validationCustom03" required="">
                                </div>
                                <div class="col-xl-6 mb-3">
                                    <label for="validationCustom05">شماره سند</label>
                                    <input type="text" class="form-control" id="validationCustom05" required="">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" form="needs-validation-form">ثبت</button>
                <button type="button" class="btn btn-default" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
            document.addEventListener('DOMContentLoaded', function () {
            // اعتبارسنجی فرم
            const form = document.querySelector('.needs-validation');
            const submitButton = document.querySelector('.modal-content .btn-primary');

            submitButton.addEventListener('click', function (event) {
                event.preventDefault();
                event.stopPropagation();

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                // جمع‌آوری اطلاعات فرم
                const nationalId = document.getElementById('validationCustom01').value;
                const mobileNumber = document.getElementById('validationCustom02').value;
                const verificationCode = document.getElementById('validationCustom03').value;
                const documentNumber = document.getElementById('validationCustom05').value;

                // ایجاد مدل برای درخواست‌های API
                const mobileCheckModel = {
                    NationalId: nationalId,
                    MobileNumber: mobileNumber
                };

                const documentVerifyModel = {
                    DocumentNumber: documentNumber,
                    VerificationCode: verificationCode
                };

                // ارسال درخواست به API برای بررسی کد ملی و شماره موبایل
                fetch('/api/ShahkarService/CheckMobileNationalCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // اگر توکن احراز هویت لازم است، اینجا اضافه کنید
                        // 'Authorization': 'Bearer ' + yourToken
                    },
                    body: JSON.stringify(mobileCheckModel)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(error => { throw new Error(error.Message || 'خطا در بررسی کد ملی و شماره موبایل'); });
                    }
                    return response.json();
                })
                .then(mobileCheckResult => {
                    // ارسال درخواست برای بررسی سند
                    return fetch('/api/ShahkarService/VerifyDocument', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // اگر توکن احراز هویت لازم است، اینجا اضافه کنید
                            // 'Authorization': 'Bearer ' + yourToken
                        },
                        body: JSON.stringify(documentVerifyModel)
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(error => { throw new Error(error.errorDescription || 'خطا در بررسی سند'); });
                        }
                        return response.json();
                    })
                    .then(verifyDocResult => {
                        // اضافه کردن ردیف جدید به جدول
                        const tableBody = document.querySelector('#cartableTable tbody');
                        const newRow = document.createElement('tr');

                        newRow.innerHTML = `
                            <td>${mobileCheckResult.RequestCode || 'نامشخص'}</td>
                            <td>${nationalId}</td>
                            <td>${mobileNumber}</td>
                            <td>${documentNumber}</td>
                            <td>${verificationCode}</td>
                            <td>
                                <i class="fas fa-check-circle text-success" title="تأیید شده" style="${mobileCheckResult.IsMatch ? '' : 'display: none;'}"></i>
                            </td>
                            <td>
                                <i class="fas fa-file-alt text-success" title="سند موجود" style="${verifyDocResult.isSuccessful && verifyDocResult.responseText.includes('ExistDoc":true') ? '' : 'display: none;'}"></i>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary verify-btn" data-document-id="${documentNumber}" data-status="pending" onclick="verifyDocument(this)">
                                    بررسی
                                </button>
                            </td>
                        `;

                        // حذف پیام "درخواستی یافت نشد" اگر وجود داشته باشد
                        const noDataRow = tableBody.querySelector('tr td[colspan="8"]');
                        if (noDataRow) {
                            noDataRow.parentElement.remove();
                        }

                        tableBody.insertBefore(newRow, tableBody.firstChild);

                        // بستن مودال و ریست فرم
                        const modal = bootstrap.Modal.getInstance(document.getElementById('scrollingmodal'));
                        modal.hide();
                        form.reset();
                        form.classList.remove('was-validated');

                        // نمایش پیام موفقیت
                        alert('درخواست با موفقیت ثبت شد.');
                    });
                })
                .catch(error => {
                    console.error('خطا:', error);
                    alert('خطا در ثبت درخواست: ' + error.message);
                });
            });

            // تابع بررسی سند (برای دکمه‌های بررسی در جدول)
            window.verifyDocument = function (button) {
                const documentId = button.getAttribute('data-document-id');
                const status = button.getAttribute('data-status');
                alert(`بررسی سند با شناسه: ${documentId}, وضعیت: ${status}`);
                // اینجا می‌توانید منطق بررسی سند را اضافه کنید
            };
        });
    </script>
}
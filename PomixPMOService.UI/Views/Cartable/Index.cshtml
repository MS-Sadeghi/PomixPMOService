@model IEnumerable<PomixPMOService.UI.ViewModels.CartableItemViewModel>
@{
    ViewData["Title"] = "کارتابل";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="input-group mb-5">
    <input type="text" class="form-control" placeholder="جستجو">
    <div class="input-group-text btn btn-primary">
        <i class="fa fa-search" aria-hidden="true"></i>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <h2 class="card-title">درخواست‌ها</h2>
        <button id="AddDoc" type="button" class="btn btn-primary btn-pill left-btn" data-bs-toggle="modal" data-bs-target="#scrollingmodal">سند جدید</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <div id="basic-datatable_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <table id="cartableTable" class="table table-bordered text-nowrap border-bottom">
                            <thead>
                                <tr role="row">
                                    <th class="wd-15p border-bottom-0 sorting sorting_asc">شماره درخواست</th>
                                    <th class="wd-15p border-bottom-0 sorting">کد ملی</th>
                                    <th class="wd-20p border-bottom-0 sorting">شماره همراه</th>
                                    <th class="wd-15p border-bottom-0 sorting">شناسه سند</th>
                                    <th class="wd-10p border-bottom-0 sorting">رمز تصدیق</th>
                                    <th class="wd-10p border-bottom-0 sorting">وضعیت احراز هویت</th>
                                    <th class="wd-10p border-bottom-0 sorting">وجود سند</th>
                                    <th class="wd-15p border-bottom-0 sorting">بررسی سند</th>
                                </tr>
                            </thead>
                            <tbody id="cartableBody">
                                <!-- داده‌ها به‌صورت داینامیک با JavaScript پر می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding New Document -->
<div class="modal fade" id="scrollingmodal" tabindex="-1" aria-labelledby="scrollingmodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="panel panel-primary">
                            <div class="tab-menu-heading">
                                <div class="tabs-menu1">
                                    <!-- Tabs -->
                                    <ul class="nav panel-tabs">
                                        <li><a href="#tab1" data-bs-toggle="tab" class="active">ایجاد سند جدید</a></li>
                                        <li><a href="#tab2" data-bs-toggle="tab" class="disabled">نمایش سند</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="panel-body tabs-menu-body">
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab1">
                                        <form class="form-horizontal" id="needs-validation-form">
                                            <!-- Step 1: احراز هویت -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">احراز هویت:</label>
                                                <div class="col-md-9">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2 mb-md-0">
                                                            <input class="form-control" id="national_code" name="national_code" placeholder="کد ملی" required type="text" autocomplete="username">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input class="form-control" id="mobile_number" name="mobile_number" placeholder="شماره موبایل" required type="text" autocomplete="username">
                                                        </div>
                                                    </div>
                                                    <span id="message-step1" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Step 2: احراز سند -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">احراز سند:</label>
                                                <div class="col-md-9">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2 mb-md-0">
                                                            <input class="form-control" id="verify_code" name="verify_code" placeholder="رمز تصدیق" required type="text">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input class="form-control" id="document_number" name="document_number" placeholder="شناسه سند" required type="text">
                                                        </div>
                                                    </div>
                                                    <span id="message-step2" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Step 3: تطابق کد ملی -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">تطابق کد ملی:</label>
                                                <div class="col-md-9">
                                                    <input class="form-control" id="client_national_code" name="client_national_code" placeholder="کد ملی موکل" required type="text">
                                                    <span id="message-step3" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Checkbox -->
                                            <div class="mb-4 row justify-content-end">
                                                <div class="col-md-9">
                                                    <label class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input" id="invalidCheck2" required>
                                                        <span class="custom-control-label">با شرایط موافق هستم</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <!-- Buttons -->
                                            <div class="modal-footer">
                                                <div class="col-md-9">
                                                    <button type="button" class="btn btn-primary" id="checkAllBtn">بررسی</button>
                                                </div>
                                                <a href="javascript:void(0)" class="btn btn-azure" id="submitBtn">ثبت</a>
                                                <a href="javascript:void(0)" class="btn btn-default" data-bs-dismiss="modal">انصراف</a>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="tab-pane" id="tab2">
                                        @* محتوای سند *@
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const checkAllBtn = $('#checkAllBtn');
            const submitBtn = $('#submitBtn');
            let checkResults = {
                step1: false,
                step2: false,
                step3: false
            };

            // Function to show result message
            function showResultMessage(step, isSuccess, message) {
            const colorClass = isSuccess ? 'text-success' : 'text-danger';
            const icon = isSuccess ? '<i class="fe fe-thumbs-up me-1"></i>' : '<i class="fe fe-slash me-1"></i>';
               $(`#message-step${step}`).html(`<span class="${colorClass} d-block text-start">${icon}${message}</span>`);

                // Update check results
                checkResults[step] = isSuccess;

                // Check if all steps are successful
                const allSuccess = checkResults.step1 && checkResults.step2 && checkResults.step3;
                submitBtn.toggle(allSuccess);
            }

            // Check All Button Click
            checkAllBtn.on('click', function () {
                // Reset results
                checkResults = { step1: false, step2: false, step3: false };
                $('#message-step1').html('');
                $('#message-step2').html('');
                $('#message-step3').html('');
                submitBtn.hide();

                // Step 1: احراز هویت
                checkStep1();
            });

            // Step 1: احراز هویت
            function checkStep1() {
                const nationalCode = $('#national_code').val().trim();
                const mobileNumber = $('#mobile_number').val().trim();

                // Client-side validation
                if (!nationalCode || nationalCode.length !== 10 || !/^\d{10}$/.test(nationalCode)) {
                    showResultMessage('1', false, 'کد ملی باید ۱۰ رقم باشد.');
                    return;
                }
                if (!mobileNumber || mobileNumber.length !== 11 || !/^09\d{9}$/.test(mobileNumber)) {
                    showResultMessage('1', false, 'شماره موبایل باید ۱۱ رقم و با ۰۹ شروع شود.');
                    return;
                }

                // Show loading
                checkAllBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> در حال بررسی...');

                // Get JWT token
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showResultMessage('1', false, 'لطفاً ابتدا وارد شوید.');
                    checkAllBtn.prop('disabled', false).html('بررسی');
                    window.location.href = '/Home/LoginPage';
                    return;
                }

                // Send request
                $.ajax({
                    url: 'http://localhost:5066/api/Service/CheckMobileNationalCode',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'Authorization': `Bearer ${token}` },
                    data: JSON.stringify({
                        nationalId: nationalCode,
                        mobileNumber: mobileNumber
                    }),
                    success: function (response) {
                        if (response.isSuccessful) {
                            try {
                                const internalResponse = JSON.parse(response.responseText);
                                if (internalResponse?.result?.data?.response === 200) {
                                    showResultMessage('1', true, 'احراز هویت با موفقیت انجام شد');
                                    // Proceed to step 2
                                    setTimeout(() => checkStep2(), 500);
                                } else if (internalResponse?.result?.data?.response === 600) {
                                    showResultMessage('1', false, 'کد ملی و شماره موبایل تطابق ندارند');
                                    checkAllBtn.prop('disabled', false).html('بررسی');
                                } else {
                                    showResultMessage('1', false, 'خطا در احراز هویت: ' + (internalResponse?.result?.data?.comment || 'پاسخ نامعتبر'));
                                    checkAllBtn.prop('disabled', false).html('بررسی');
                                }
                            } catch (e) {
                                showResultMessage('1', false, 'خطا در پردازش پاسخ سرویس');
                                checkAllBtn.prop('disabled', false).html('بررسی');
                            }
                        } else {
                            showResultMessage('1', false, response.errorDescription || 'خطا در احراز هویت');
                            checkAllBtn.prop('disabled', false).html('بررسی');
                        }
                    },
                    error: function (xhr) {
                        let errorMsg = 'خطا در ارتباط با سرویس.';
                        if (xhr.status === 401) {
                            errorMsg = 'عدم دسترسی: لطفاً دوباره وارد شوید.';
                            window.location.href = '/Home/LoginPage';
                        } else if (xhr.status === 429) {
                            errorMsg = 'تعداد درخواست‌ها بیش از حد مجاز است.';
                        } else if (xhr.responseJSON && xhr.responseJSON.errorDescription) {
                            errorMsg = xhr.responseJSON.errorDescription;
                        }
                        showResultMessage('1', false, errorMsg);
                        checkAllBtn.prop('disabled', false).html('بررسی');
                    }
                });
            }

            // Step 2: احراز سند
            function checkStep2() {
                const verifyCode = $('#verify_code').val().trim();
                const documentNumber = $('#document_number').val().trim();

                // Client-side validation
                if (!verifyCode || verifyCode.length !== 6 || !/^\d{6}$/.test(verifyCode)) {
                    showResultMessage('2', false, 'رمز تصدیق باید ۶ رقم باشد.');
                    checkAllBtn.prop('disabled', false).html('بررسی');
                    return;
                }
                if (!documentNumber || documentNumber.length !== 18 || !/^\d{18}$/.test(documentNumber)) {
                    showResultMessage('2', false, 'شناسه سند باید ۱۸ رقم باشد.');
                    checkAllBtn.prop('disabled', false).html('بررسی');
                    return;
                }

                // Get JWT token
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showResultMessage('2', false, 'لطفاً ابتدا وارد شوید.');
                    checkAllBtn.prop('disabled', false).html('بررسی');
                    window.location.href = '/Home/LoginPage';
                    return;
                }

                // Send request
                $.ajax({
                    url: 'http://localhost:5066/api/Service/VerifyDocument',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'Authorization': `Bearer ${token}` },
                    data: JSON.stringify({
                        verificationCode: verifyCode,
                        documentNumber: documentNumber
                    }),
                    success: function (response) {
                        if (response.isSuccessful) {
                            try {
                                const internalResponse = JSON.parse(response.responseText);
                                if (internalResponse?.result?.data?.response === 200) {
                                    showResultMessage('2', true, 'سند با موفقیت تایید شد');
                                    // Proceed to step 3
                                    setTimeout(() => checkStep3(), 500);
                                } else if (internalResponse?.result?.data?.response === 600) {
                                    showResultMessage('2', false, 'سند تایید نشد');
                                    checkAllBtn.prop('disabled', false).html('بررسی');
                                } else {
                                    showResultMessage('2', false, 'خطا در تایید سند: ' + (internalResponse?.result?.data?.comment || 'پاسخ نامعتبر'));
                                    checkAllBtn.prop('disabled', false).html('بررسی');
                                }
                            } catch (e) {
                                showResultMessage('2', false, 'خطا در پردازش پاسخ سرویس');
                                checkAllBtn.prop('disabled', false).html('بررسی');
                            }
                        } else {
                            showResultMessage('2', false, response.errorDescription || 'خطا در تایید سند');
                            checkAllBtn.prop('disabled', false).html('بررسی');
                        }
                    },
                    error: function (xhr) {
                        let errorMsg = 'خطا در ارتباط با سرویس.';
                        if (xhr.status === 401) {
                            errorMsg = 'عدم دسترسی: لطفاً دوباره وارد شوید.';
                            window.location.href = '/Home/LoginPage';
                        } else if (xhr.status === 429) {
                            errorMsg = 'تعداد درخواست‌ها بیش از حد مجاز است.';
                        } else if (xhr.responseJSON && xhr.responseJSON.errorDescription) {
                            errorMsg = xhr.responseJSON.errorDescription;
                        }
                        showResultMessage('2', false, errorMsg);
                        checkAllBtn.prop('disabled', false).html('بررسی');
                    }
                });
            }

            // Step 3: تطابق کد ملی
            function checkStep3() {
                const clientNationalCode = $('#client_national_code').val().trim();

                // Client-side validation
                if (!clientNationalCode || clientNationalCode.length !== 10 || !/^\d{10}$/.test(clientNationalCode)) {
                    showResultMessage('3', false, 'کد ملی موکل باید ۱۰ رقم باشد.');
                    checkAllBtn.prop('disabled', false).html('بررسی');
                    return;
                }

                // Simulate API call (replace with actual API call)
                setTimeout(() => {
                    // This is a simulation - replace with actual API call
                    const isSuccess = true; // Simulate success

                    if (isSuccess) {
                        showResultMessage('3', true, 'تطابق کد ملی با موفقیت انجام شد');
                    } else {
                        showResultMessage('3', false, 'کد ملی موکل تطابق ندارد');
                    }

                    checkAllBtn.prop('disabled', false).html('بررسی');
                }, 1000);
            }

            // Submit Button Click
            submitBtn.on('click', function () {
                if (checkResults.step1 && checkResults.step2 && checkResults.step3) {
                    alert('ثبت نهایی انجام شد!');
                    $('#scrollingmodal').modal('hide');
                    // Reset form
                    $('#needs-validation-form')[0].reset();
                    $('#message-step1').html('');
                    $('#message-step2').html('');
                    $('#message-step3').html('');
                    submitBtn.hide();
                }
            });
        });
    </script>
}
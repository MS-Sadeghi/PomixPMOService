@using DNTCaptcha.Core
@model PomixPMOService.UI.ViewModels.LoginViewModel
@{
    ViewData["Title"] = "ورود به سامانه";
    Layout = "~/Views/Shared/_LayoutAuth.cshtml";
}

<style>
    .captchaInput, .dnt-captcha-img {
        display: block !important;
        visibility: visible !important;
        width: 200px;
        height: 80px;
    }
</style>

<div class="page">
    <div class="container-login100">
        <div class="wrap-login100 p-6">
            <form id="loginForm" class="login100-form validate-form" autocomplete="off">
                <span class="login100-form-title">ورود به سیستم</span>

                <!-- User Type Selection -->
                <div class="wrap-input100 validate-input input-group" data-bs-validate="لطفا نوع کاربری را انتخاب کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="mdi mdi-account" aria-hidden="true"></i>
                    </a>
                    <select class="input100 border-start-0 ms-0 form-control" name="userType" id="userType" required>
                        <option value="1" selected>کاربر احراز هویت</option>
                        <option value="2">کاربر متقاضی خدمت</option>
                    </select>
                </div>

                <!-- Username Input -->
                <div class="wrap-input100 validate-input input-group" data-bs-validate="لطفا نام کاربری را وارد کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="mdi mdi-account" aria-hidden="true"></i>
                    </a>
                    <input asp-for="Username" class="input100 border-start-0 ms-0 form-control" placeholder="نام کاربری" required />
                    <span asp-validation-for="Username" class="text-danger"></span>
                </div>

                <!-- Password Input -->
                <div class="wrap-input100 validate-input input-group" id="Password-toggle" data-bs-validate="لطفا رمز عبور را وارد کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="zmdi zmdi-eye" aria-hidden="true"></i>
                    </a>
                    <input asp-for="Password" type="password" class="input100 border-start-0 ms-0 form-control" placeholder="کلمه عبور" required />
                    <span asp-validation-for="Password" class="text-danger"></span>
                </div>

                <div>
                    <dnt-captcha asp-captcha-generator-max="9999"
                                                 asp-captcha-generator-min="1000"
                                                 asp-captcha-generator-language="English"
                                                 asp-captcha-generator-display-mode="ShowDigits"
                                                 asp-use-relative-urls="true"
                                                 asp-placeholder="کد امنیتی را وارد کنید"
                                                 asp-validation-error-message=" "
                                                 asp-too-many-requests-error-message="Too many requests! Please wait a minute!"
                                                 asp-font-name="Tahoma"
                                                 asp-font-size="30"
                                                 asp-fore-color="#3333333"
                                                 asp-back-color="#FCF6F5FF"
                                                 asp-text-box-class="form-control captchaInput"
                                                 asp-text-box-template="<div class='form-group'>{0}</div>"
                                                 asp-validation-message-class="text-danger"
                                                 asp-refresh-button-class="bx bx-sync btn "
                                                 asp-show-refresh-button="true" /> 
                </div>

                <!-- Two-Factor Authentication Type -->
                <div class="wrap-input100 validate-input input-group" data-bs-validate="لطفا روش تأیید دو عاملی را انتخاب کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="zmdi zmdi-key" aria-hidden="true"></i>
                    </a>
                    <select class="input100 border-start-0 ms-0 form-control" name="twoFactorType" id="twoFactorType" required>
                        <option value="1" selected>پیامک</option>
                        <option value="2">Google Authenticator</option>
                    </select>
                </div>

                <!-- SMS Section -->
                <div id="smsSection" class="wrap-input100 validate-input input-group" data-bs-validate="لطفا شماره موبایل را وارد کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="zmdi zmdi-smartphone" aria-hidden="true"></i>
                    </a>
                    <input class="input100 border-start-0 ms-0 form-control" type="text" id="mobileNumber" name="mobileNumber" placeholder="شماره موبایل" />
                    <button type="button" onclick="sendSMS()" class="btn btn-primary">ارسال کد</button>
                </div>

                <div id="smsCodeSection" class="wrap-input100 validate-input input-group" style="display: none;" data-bs-validate="لطفا کد تأیید را وارد کنید">
                    <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                        <i class="zmdi zmdi-shield-check" aria-hidden="true"></i>
                    </a>
                    <input class="input100 border-start-0 ms-0 form-control" type="text" id="smsCode" name="smsCode" placeholder="کد تأیید" />
                </div>

                <!-- Google Authenticator Section -->
                 <div id="googleAuthSection" class="wrap-input100 validate-input input-group" style="display: none;" data-bs-validate="لطفا کد Google Authenticator را وارد کنید">
                    <dnt-captcha asp-captcha-generator-max="9999"
                                 asp-captcha-generator-min="1000"
                                 asp-captcha-generator-language="English"
                                 asp-captcha-generator-display-mode="ShowDigits"
                                 asp-use-relative-urls="true"
                                 asp-placeholder="کد امنیتی را وارد کنید"
                                 asp-validation-error-message=" "
                                 asp-too-many-requests-error-message="Too many requests! Please wait a minute!"
                                 asp-font-name="Tahoma"
                                 asp-font-size="30"
                                 asp-fore-color="#3333333"
                                 asp-back-color="#FCF6F5FF"
                                 asp-text-box-class="form-control captchaInput"
                                 asp-text-box-template="<div class='form-group'>{0}</div>"
                                 asp-validation-message-class="text-danger"
                                 asp-refresh-button-class="bx bx-sync btn "
                                 asp-show-refresh-button="true" />
                    
                    <div class="wrap-input100 validate-input input-group" data-bs-validate="لطفا کد Google Authenticator را وارد کنید">
                        <a href="javascript:void(0)" class="input-group-text bg-white text-muted">
                            <i class="zmdi zmdi-shield-check" aria-hidden="true"></i>
                        </a>
                        <input class="input100 border-start-0 ms-0 form-control" type="text" id="googleAuthCode" name="googleAuthCode" placeholder="کد Google Authenticator" />
                    </div>
                </div> 

              

                <!-- Submit Button -->
                <div class="container-login100-form-btn mt-4">
                    <button type="submit" class="login100-form-btn btn-primary">ورود به سامانه</button>
                </div>

                <!-- Error Message -->
                @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
                {
                    <div class="text-danger">@ViewBag.ErrorMessage</div>
                }
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Toggle visibility and required attributes based on twoFactorType selection
        document.getElementById('twoFactorType').addEventListener('change', function() {
            const smsSection = document.getElementById('smsSection');
            const smsCodeSection = document.getElementById('smsCodeSection');
            const googleAuthSection = document.getElementById('googleAuthSection');
            const mobileNumberInput = document.getElementById('mobileNumber');
            const smsCodeInput = document.getElementById('smsCode');
            const googleAuthCodeInput = document.getElementById('googleAuthCode');

            if (this.value === '1') { // SMS
                smsSection.style.display = 'flex';
                googleAuthSection.style.display = 'none';
                mobileNumberInput.setAttribute('required', 'required');
                googleAuthCodeInput.removeAttribute('required');
            } else { // Google Authenticator
                smsSection.style.display = 'none';
                smsCodeSection.style.display = 'none';
                googleAuthSection.style.display = 'block';
                mobileNumberInput.removeAttribute('required');
                smsCodeInput.removeAttribute('required');
                googleAuthCodeInput.setAttribute('required', 'required');
            }
        });

        // Placeholder function for sending SMS
        function sendSMS() {
            const mobileNumber = document.getElementById('mobileNumber').value;
            if (mobileNumber) {
                document.getElementById('smsCodeSection').style.display = 'flex';
                document.getElementById('smsCode').setAttribute('required', 'required');
                alert('کد تأیید به شماره ' + mobileNumber + ' ارسال شد.');
                // اینجا منطق واقعی ارسال SMS را اضافه کنید
            } else {
                alert('لطفا شماره موبایل را وارد کنید.');
            }
        }

        // مدیریت فرم لاگین
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const username = document.getElementById('Username').value;
            const password = document.getElementById('Password').value;
            const twoFactorType = document.getElementById('twoFactorType').value;
            const mobileNumber = document.getElementById('mobileNumber').value;
            const smsCode = document.getElementById('smsCode').value;
            const googleAuthCode = document.getElementById('googleAuthCode').value;

            try {
                const response = await fetch('http://localhost:5066/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                        // اگر احراز هویت دو مرحله‌ای فعال است، اینجا اضافه کنید
                        // twoFactorType,
                        // mobileNumber,
                        // smsCode,
                        // googleAuthCode
                    })
                });

                const result = await response.json();
                if (!response.ok) {
                    document.getElementById('errorMessage').innerText = result.message || 'خطا در ورود';
                    return;
                }

                // ذخیره توکن‌ها در localStorage
                localStorage.setItem('accessToken', result.tokens.accessToken);
                localStorage.setItem('refreshToken', result.tokens.refreshToken);

                // هدایت به صفحه اصلی
                window.location.href = '/Home/Index';
            } catch (error) {
                document.getElementById('errorMessage').innerText = 'خطا در ارتباط با سرور';
                console.error(error);
            }
        });
    </script>
}
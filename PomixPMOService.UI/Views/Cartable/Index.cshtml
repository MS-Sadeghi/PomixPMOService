@model IEnumerable<PomixPMOService.UI.ViewModels.CartableItemViewModel>
@{
    ViewData["Title"] = "کارتابل";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="input-group mb-5">
    <input type="text" class="form-control" placeholder="جستجو" id="searchInput">
    <div class="input-group-text btn btn-primary">
        <i class="fa fa-search" aria-hidden="true"></i>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <h2 class="card-title">درخواست‌ها</h2>
        <button id="AddDoc" type="button" class="btn btn-primary btn-pill left-btn" data-bs-toggle="modal" data-bs-target="#scrollingmodal">سند جدید</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <div id="basic-datatable_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <table id="cartableTable" class="table table-bordered text-nowrap border-bottom">
                            <thead>
                                <tr role="row">
                                    <th class="wd-15p border-bottom-0 sorting sorting_asc">شماره درخواست</th>
                                    <th class="wd-15p border-bottom-0 sorting">کد ملی</th>
                                    <th class="wd-20p border-bottom-0 sorting">شماره همراه</th>
                                    <th class="wd-15p border-bottom-0 sorting">شناسه سند</th>
                                    <th class="wd-10p border-bottom-0 sorting">رمز تصدیق</th>
                                    <th class="wd-10p border-bottom-0 sorting">وضعیت احراز هویت</th>
                                    <th class="wd-10p border-bottom-0 sorting">وجود سند</th>
                                    <th class="wd-15p border-bottom-0 sorting">بررسی سند</th>
                                </tr>
                            </thead>
                            <tbody id="cartableBody">
                                <!-- داده‌ها به‌صورت داینامیک با JavaScript پر می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- صفحه‌بندی -->
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-end" id="pagination">
                        <li class="page-item" id="prevPage">
                            <a class="page-link" href="javascript:void(0)">
                                <i class="fa fa-angle-left"></i>
                                <span class="sr-only"><</span>
                            </a>
                        </li>
                        <!-- لینک‌های صفحه به‌صورت داینامیک پر می‌شوند -->
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="javascript:void(0)">
                                <i class="fa fa-angle-right"></i>
                                <span class="sr-only">></span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding New Document -->
<div class="modal fade" id="scrollingmodal" tabindex="-1" aria-labelledby="scrollingmodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="panel panel-primary">
                            <div class="tab-menu-heading">
                                <div class="tabs-menu1">
                                    <!-- Tabs -->
                                    <ul class="nav panel-tabs">
                                        <li><a href="#tab1" data-bs-toggle="tab" class="active">ایجاد سند جدید</a></li>
                                        <li><a href="#tab2" data-bs-toggle="tab" class="disabled">نمایش سند</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="panel-body tabs-menu-body">
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab1">
                                        <form class="form-horizontal" id="needs-validation-form">
                                            <!-- Step 1: احراز هویت -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">احراز هویت:</label>
                                                <div class="col-md-9">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2 mb-md-0">
                                                            <input class="form-control" id="national_code" name="national_code" placeholder="کد ملی" required type="text" autocomplete="username">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input class="form-control" id="mobile_number" name="mobile_number" placeholder="شماره موبایل" required type="text" autocomplete="username">
                                                        </div>
                                                    </div>
                                                    <span id="message-step1" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Step 2: احراز سند -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">احراز سند:</label>
                                                <div class="col-md-9">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2 mb-md-0">
                                                            <input class="form-control" id="verify_code" name="verify_code" placeholder="رمز تصدیق" required type="text">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input class="form-control" id="document_number" name="document_number" placeholder="شناسه سند" required type="text">
                                                        </div>
                                                    </div>
                                                    <span id="message-step2" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Step 3: تطابق کد ملی -->
                                            <div class="row mb-4">
                                                <label class="col-md-3 form-label">تطابق کد ملی:</label>
                                                <div class="col-md-9">
                                                    <input class="form-control" id="client_national_code" name="client_national_code" placeholder="کد ملی موکل" required type="text">
                                                    <span id="message-step3" class="form-text"></span>
                                                </div>
                                            </div>
                                            <!-- Checkbox -->
                                            <div class="mb-4 row justify-content-end">
                                                <div class="col-md-9">
                                                    <label class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input" id="invalidCheck2" required>
                                                        <span class="custom-control-label">با شرایط موافق هستم</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <!-- Buttons -->
                                            <div class="modal-footer">
                                                <div class="col-md-9">
                                                    <button type="button" class="btn btn-primary me-5" id="checkAllBtn">بررسی</button>
                                                </div>
                                                <a href="javascript:void(0)" class="btn btn-azure" id="submitBtn">ثبت</a>
                                                <a href="javascript:void(0)" class="btn btn-default" data-bs-dismiss="modal">انصراف</a>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="tab-pane" id="tab2">
                                        @* محتوای سند *@
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBaseUrl = 'http://localhost:5066/api/';
        const token = localStorage.getItem('jwtToken');
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let currentSearch = ''; 

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function resetModalForm() {
            $('#needs-validation-form')[0].reset();
            $('#message-step1, #message-step2, #message-step3').text('').css('color', '');
            $('#invalidCheck2').prop('checked', false);
        }

        $(document).ready(function() {
            loadCartableData();

            $('.input-group-text.btn').on('click', function() {
                currentSearch = $('#searchInput').val().trim();
                currentPage = 1;
                loadCartableData();
            });

            $('#checkAllBtn').on('click', function() {
                validateSteps();
            });

            $('#submitBtn').on('click', function() {
                submitRequest();
            });

            $('#scrollingmodal').on('hidden.bs.modal', function() {
                resetModalForm();
            });

            $('#pagination').on('click', '.page-link', function(e) {
                e.preventDefault();
                const pageText = $(this).text().trim();
                if ($(this).parent().attr('id') === 'prevPage') {
                    if (currentPage > 1) {
                        currentPage--;
                        loadCartableData();
                    }
                } else if ($(this).parent().attr('id') === 'nextPage') {
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadCartableData();
                    }
                } else if (!isNaN(pageText)) {
                    currentPage = parseInt(pageText);
                    loadCartableData();
                }
            });
        });

        function loadCartableData() {
            let url = `${apiBaseUrl}Request?page=${currentPage}&pageSize=${pageSize}`;
            if (currentSearch) {
                url += `&search=${encodeURIComponent(currentSearch)}`;
            }

            fetch(url, {
                method: 'GET',
                headers: getHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('لطفاً ابتدا وارد سیستم شوید.');
                        window.location.href = '/Home/LoginPage';
                    }
                    throw new Error('خطا در دریافت داده‌ها');
                }
                return response.json();
            })
            .then(data => {
                populateTable(data.items);
                totalPages = data.totalPages;
                updatePagination(data.totalCount);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در بارگذاری داده‌ها: ' + error.message);
            });
        }

        function populateTable(items) {
            const tbody = $('#cartableBody');
            tbody.empty();
            items.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.requestId || ''}</td>
                        <td>${item.nationalId || ''}</td>
                        <td>${item.mobileNumber || ''}</td>
                        <td>${item.documentNumber || ''}</td>
                        <td>${item.verificationCode || ''}</td>
                        <td>${item.isMatch ? 'تایید شده' : 'تایید نشده'}</td>
                        <td>${item.isExist ? 'وجود دارد' : 'وجود ندارد'}</td>
                        <td>${item.isNationalIdInResponse ? 'تایید شده' : 'تایید نشده'}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updatePagination(totalCount) {
            totalPages = Math.ceil(totalCount / pageSize);
            const pagination = $('#pagination');
            pagination.empty();

            pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" id="prevPage">
                    <a class="page-link" href="javascript:void(0)">
                        <i class="fa fa-angle-right"></i>
                        <span class="sr-only"><</span>
                    </a>
                </li>
            `);

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            startPage = Math.max(1, endPage - maxVisiblePages + 1);

            for (let i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)">${i}</a>
                    </li>
                `);
            }

            pagination.append(`
                <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}" id="nextPage">
                    <a class="page-link" href="javascript:void(0)">
                        <i class="fa fa-angle-left"></i>
                        <span class="sr-only">></span>
                    </a>
                </li>
            `);
        }

        function validateSteps() {
            const nationalCode = $('#national_code').val().trim();
            const mobileNumber = $('#mobile_number').val().trim();
            const verifyCode = $('#verify_code').val().trim();
            const documentNumber = $('#document_number').val().trim();
            const clientNationalCode = $('#client_national_code').val().trim();
            const checkbox = $('#invalidCheck2').is(':checked');

            $('#message-step1, #message-step2, #message-step3').text('');

            let isValid = true;

            // گام 1: احراز هویت
            if (!nationalCode || nationalCode.length !== 10 || !/^\d{10}$/.test(nationalCode)) {
                $('#message-step1').text('کد ملی نامعتبر است.').css('color', 'red');
                isValid = false;
            }
            if (!mobileNumber || mobileNumber.length !== 11 || !/^09\d{9}$/.test(mobileNumber)) {
                $('#message-step1').text($('#message-step1').text() + ' شماره موبایل نامعتبر است.').css('color', 'red');
                isValid = false;
            }
            if (isValid) {
                $('#message-step1').text('احراز هویت معتبر است.').css('color', 'green');
            }

            // گام 2: احراز سند
            if (!verifyCode || verifyCode.length !== 6 || !/^\d{6}$/.test(verifyCode)) {
                $('#message-step2').text('رمز تصدیق نامعتبر است.').css('color', 'red');
                isValid = false;
            }
            if (!documentNumber || documentNumber.length !== 18 || !/^\d{18}$/.test(documentNumber)) {
                $('#message-step2').text($('#message-step2').text() + ' شناسه سند نامعتبر است.').css('color', 'red');
                isValid = false;
            }
            if (isValid) {
                $('#message-step2').text('احراز سند معتبر است.').css('color', 'green');
            }

            // گام 3: تطابق کد ملی
            if (!clientNationalCode || clientNationalCode.length !== 10 || !/^\d{10}$/.test(clientNationalCode)) {
                $('#message-step3').text('کد ملی موکل نامعتبر است.').css('color', 'red');
                isValid = false;
            } else {
                $('#message-step3').text('تطابق کد ملی معتبر است.').css('color', 'green');
            }

            if (!checkbox) {
                alert('لطفاً با شرایط موافقت کنید.');
                isValid = false;
            }

            if (isValid) {
                alert('همه گام‌ها معتبر هستند.');
            }
        }

        // تابع ارسال درخواست به API
        function submitRequest() {
            const nationalCode = $('#national_code').val().trim();
            const mobileNumber = $('#mobile_number').val().trim();
            const verifyCode = $('#verify_code').val().trim();
            const documentNumber = $('#document_number').val().trim();
            const clientNationalCode = $('#client_national_code').val().trim();
            const checkbox = $('#invalidCheck2').is(':checked');

            if (!checkbox) {
                alert('لطفاً با شرایط موافقت کنید.');
                return;
            }

            const requestData = {
                NationalId: clientNationalCode,
                MobileNumber: mobileNumber,
                DocumentNumber: documentNumber,
                VerificationCode: verifyCode
            };

            fetch(`${apiBaseUrl}Service/ProcessCombinedRequest`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('لطفاً ابتدا وارد سیستم شوید.');
                        window.location.href = '/Home/LoginPage';
                    }
                    throw new Error('خطا در ارسال درخواست');
                }
                return response.json();
            })
            .then(data => {
                alert('درخواست با موفقیت ثبت شد.');
                $('#scrollingmodal').modal('hide');
                currentPage = 1; 
                loadCartableData(); 
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در ثبت درخواست: ' + error.message);
            });
        }
    </script>
}